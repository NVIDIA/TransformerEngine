<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1150 400" width="100%" style="max-width: 900px;">
  <defs>
    <style>
      @import url("../_static/css/diagram-colors.css");
      
      /* Diagram-specific styles */
      .input-box { fill: #f3e5f5; stroke: #7b1fa2; stroke-width: 2.5; }
      .blockwise-box { fill: #e3f2fd; stroke: #1976d2; stroke-width: 2.5; }
      .fp8-tile { fill: #bbdefb; stroke: #1565c0; stroke-width: 1.5; }
      .scale-tile { fill: #a5d6a7; stroke: #388e3c; stroke-width: 1.5; }
      .scale-swizzled { fill: #ffb74d; stroke: #e65100; stroke-width: 1.5; }
      .swizzle-box { fill: #fff3e0; stroke: #f57c00; stroke-width: 2; }
      .quantize-box { fill: #ede7f6; stroke: #5e35b1; stroke-width: 2; }
      .quantize-fused-box { fill: #d1c4e9; stroke: #5e35b1; stroke-width: 2.5; }
      .comm-box { fill: #fff9c4; stroke: #f57f17; stroke-width: 2; }
      .gemm-box { fill: #c8e6c9; stroke: #388e3c; stroke-width: 2; }
      
      /* Arrow override */
      .arrow { marker-end: url(#arrowhead); stroke: #616161; stroke-width: 1.5; fill: none; }
    </style>
    
    <!-- Arrow marker -->
    <marker id="arrowhead" markerWidth="6" markerHeight="6" refX="5" refY="2" orient="auto">
      <polygon points="0 0, 6 2, 0 4" fill="#616161" />
    </marker>
  </defs>
  
  <!-- Section 1: With Communication (Separate Swizzle) -->
  <g id="with-communication">
    <!-- Step 0: Input Tensor -->
    <g id="input-fp32-tensor-1">
      <text x="80" y="25" class="text" text-anchor="middle" font-weight="600">Input Tensor</text>
      <rect x="20" y="40" width="120" height="110" rx="6" class="input-box"/>
      <text x="80" y="100" class="text" text-anchor="middle" fill="#fff">FP32/BF16</text>
    </g>
    
    <!-- Arrow 0 -->
    <path d="M 140 95 L 175 95" class="arrow"/>
    
    <!-- Step 1: Quantize -->
    <rect x="175" y="60" width="80" height="70" rx="6" class="quantize-box"/>
    <text x="215" y="100" class="text">Quantize</text>
    
    <!-- Arrow 1 -->
    <path d="M 255 95 L 290 95" class="arrow"/>
    
    <!-- Step 2: Blockwise Tensor (Compact) -->
    <g id="blockwise-tensor-compact">
      <text x="375" y="25" class="text" text-anchor="middle" font-weight="600">FP8 (Compact)</text>
      <rect x="290" y="40" width="170" height="110" rx="6" class="blockwise-box"/>
      
      <!-- FP32 Scales sub-tile (green) -->
      <rect x="305" y="52" width="140" height="32" rx="3" class="scale-tile"/>
      <text x="375" y="73" class="text" text-anchor="middle" fill="#fff">FP32 Scales</text>
      
      <!-- FP8 Data sub-tile -->
      <rect x="305" y="92" width="140" height="45" rx="3" class="fp8-tile"/>
      <text x="375" y="120" class="text" fill="#fff">FP8 Data</text>
    </g>
    
    <!-- Arrow 2 -->
    <path d="M 460 95 L 495 95" class="arrow"/>
    
    <!-- Step 3: Communication -->
    <rect x="495" y="60" width="100" height="70" rx="6" class="comm-box"/>
    <text x="545" y="100" class="text">All-Gather</text>
    
    <!-- Arrow 3 -->
    <path d="M 595 95 L 630 95" class="arrow"/>
    
    <!-- Step 4: Swizzle -->
    <rect x="630" y="60" width="90" height="70" rx="6" class="swizzle-box"/>
    <text x="675" y="100" class="text">Swizzle</text>
    
    <!-- Arrow 4 -->
    <path d="M 720 95 L 755 95" class="arrow"/>
    
    <!-- Step 5: Blockwise Tensor (GEMM Ready) -->
    <g id="swizzled-tensor-1">
      <text x="840" y="25" class="text" text-anchor="middle" font-weight="600">FP8 (GEMM Ready)</text>
      <rect x="755" y="40" width="170" height="110" rx="6" class="blockwise-box"/>
      
      <!-- Swizzled Scales sub-tile (orange) -->
      <rect x="770" y="52" width="140" height="32" rx="3" class="scale-swizzled"/>
      <text x="840" y="73" class="text" text-anchor="middle" fill="#fff">Swizzled Scales</text>
      
      <!-- FP8 Data sub-tile -->
      <rect x="770" y="92" width="140" height="45" rx="3" class="fp8-tile"/>
      <text x="840" y="120" class="text" fill="#fff">FP8 Data</text>
    </g>
    
    <!-- Arrow 5 -->
    <path d="M 925 95 L 960 95" class="arrow"/>
    
    <!-- Step 6: GEMM -->
    <rect x="960" y="60" width="80" height="70" rx="6" class="gemm-box"/>
    <text x="1000" y="100" class="text">GEMM</text>
  </g>
  
  <!-- Separator Line -->
  <line x1="20" y1="185" x2="1050" y2="185" stroke="#bdbdbd" stroke-width="1" stroke-dasharray="8,4"/>
  
  <!-- Section 2: Without Communication (Fused Quantize + Swizzle) -->
  <g id="without-communication" transform="translate(0, 170)">
    <!-- Step 0: Input Tensor -->
    <g id="input-fp32-tensor-2">
      <text x="80" y="45" class="text" text-anchor="middle" font-weight="600">Input Tensor</text>
      <rect x="20" y="60" width="120" height="110" rx="6" class="input-box"/>
      <text x="80" y="120" class="text" text-anchor="middle" fill="#fff">FP32/BF16</text>
    </g>
    
    <!-- Arrow 0 -->
    <path d="M 140 115 L 190 115" class="arrow"/>
    
    <!-- Step 1: Fused Quantize + Swizzle -->
    <rect x="190" y="70" width="120" height="90" rx="6" class="quantize-fused-box"/>
    <text x="250" y="105" class="text">Quantize</text>
    <text x="250" y="122" class="text">+</text>
    <text x="250" y="139" class="text">Swizzle</text>
    
    <!-- Arrow 1 -->
    <path d="M 310 115 L 360 115" class="arrow"/>
    
    <!-- Step 2: Blockwise Tensor (GEMM Ready) - directly produced -->
    <g id="swizzled-tensor-2">
      <text x="455" y="45" class="text" text-anchor="middle" font-weight="600">FP8 (GEMM Ready)</text>
      <rect x="360" y="60" width="190" height="110" rx="6" class="blockwise-box"/>
      
      <!-- Swizzled Scales sub-tile (orange) -->
      <rect x="378" y="72" width="155" height="32" rx="3" class="scale-swizzled"/>
      <text x="455" y="93" class="text" text-anchor="middle" fill="#fff">Swizzled Scales</text>
      
      <!-- FP8 Data sub-tile -->
      <rect x="378" y="112" width="155" height="45" rx="3" class="fp8-tile"/>
      <text x="455" y="140" class="text" fill="#fff">FP8 Data</text>
    </g>
    
    <!-- Arrow 2 -->
    <path d="M 550 115 L 600 115" class="arrow"/>
    
    <!-- Step 3: GEMM -->
    <rect x="600" y="80" width="80" height="70" rx="6" class="gemm-box"/>
    <text x="640" y="120" class="text">GEMM</text>
  </g>
</svg>
